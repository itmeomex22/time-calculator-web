<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>บวกเวลา</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script> <!-- เพิ่ม SheetJS -->
</head>
<body>
    <h2>บวกเวลางัดร้าน</h2>
    <h3>Anything Else</h3>
    <form id="timeForm">
        <label>เลือกสถานที่:</label>
        <select id="location">
            <option value="ปั้มบน">ปั้มบน</option>
            <option value="ปั้มหอย">ปั้มหอย</option>
            <option value="อู่">อู่</option>
            <option value="กลาง">กลาง</option>
            <option value="DG">DG</option>
            <option value="มือ 2">มือ 2</option>
        </select>

        <label>เวลาปัจจุบัน:</label>
        <input type="text" id="current_time" readonly>

        <label>เพิ่มเวลา (นาที.วินาที):</label>
        <input type="text" id="add_time" placeholder="30.30" required>

        <button type="submit">คำนวณ</button>
    </form>

    <h3>ประวัติการคำนวณ</h3>
    <table border="1">
        <tr>
            <th>สถานที่</th>
            <th>เวลาปัจจุบัน</th>
            <th>เวลาหลังบวก</th>
        </tr>
        <tbody id="historyTable"></tbody>
    </table>
    <button id="resetHistory">ล้างประวัติ</button>
    <button id="downloadExcel">ดาวน์โหลด Excel</button> <!-- ปุ่มดาวน์โหลด Excel -->

    <script>
        function updateCurrentTime() {
            let now = new Date();
            let hours = String(now.getHours()).padStart(2, '0');
            let minutes = String(now.getMinutes()).padStart(2, '0');
            let seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById("current_time").value = `${hours}.${minutes}.${seconds}`;
        }

        setInterval(updateCurrentTime, 1000); // อัปเดตเวลาทุกวินาที
        updateCurrentTime(); // เรียกครั้งแรกทันที

        document.getElementById("timeForm").addEventListener("submit", function(event) {
            event.preventDefault();

            // ตรวจสอบว่าเวลาใน input เป็นไปตามรูปแบบที่ถูกต้อง
            let add_time = document.getElementById("add_time").value.split(".");
            if (add_time.length !== 2 || isNaN(add_time[0]) || isNaN(add_time[1])) {
                alert("กรุณากรอกเวลาในรูปแบบ นาที.วินาที เช่น 30.30");
                return;
            }

            let add_minutes = parseInt(add_time[0]) || 0;
            let add_seconds = parseInt(add_time[1]) || 0;
            let location = document.getElementById("location").value;

            let now = new Date();
            now.setMinutes(now.getMinutes() + add_minutes);
            now.setSeconds(now.getSeconds() + add_seconds);

            let new_time = formatTime(now);
            let current_time = document.getElementById("current_time").value;

            let history = JSON.parse(localStorage.getItem("history")) || [];
            history.push({ location, current_time, new_time });
            localStorage.setItem("history", JSON.stringify(history));

            updateHistory();
        });

        function formatTime(date) {
            let hours = String(date.getHours()).padStart(2, '0');
            let minutes = String(date.getMinutes()).padStart(2, '0');
            let seconds = String(date.getSeconds()).padStart(2, '0');
            return `${hours}.${minutes}.${seconds}`;
        }

        function updateHistory() {
            let historyTable = document.getElementById("historyTable");
            historyTable.innerHTML = "";

            let history = JSON.parse(localStorage.getItem("history")) || [];
            history.forEach(item => {
                let row = `<tr>
                    <td>${item.location}</td>
                    <td>${item.current_time}</td>
                    <td>${item.new_time}</td>
                </tr>`;
                historyTable.innerHTML += row;
            });
        }

        document.getElementById("resetHistory").addEventListener("click", function() {
            localStorage.removeItem("history");
            updateHistory();
        });

        document.getElementById("downloadExcel").addEventListener("click", function() {
            let history = JSON.parse(localStorage.getItem("history")) || [];
            
            // สร้าง Array สำหรับข้อมูลใน Excel
            let data = [["สถานที่", "เวลาปัจจุบัน", "เวลาหลังบวก"]];
            history.forEach(item => {
                data.push([item.location, item.current_time, item.new_time]);
            });

            // สร้าง worksheet จากข้อมูล
            let ws = XLSX.utils.aoa_to_sheet(data);

            // สร้าง workbook
            let wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ประวัติการคำนวณ");

            // ดาวน์โหลดไฟล์ Excel
            XLSX.writeFile(wb, "history.xlsx");
        });

        updateHistory();
    </script>
</body>
</html>
